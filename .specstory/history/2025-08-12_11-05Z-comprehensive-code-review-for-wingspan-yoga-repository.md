<!-- Generated by SpecStory -->

# Comprehensive code review for Wingspan Yoga repository (2025-08-12 11:05Z)

_**User**_

Please conduct a comprehensive code review of my Wingspan Yoga repository, using the Taskmaster task list to structure your analysis. Focus on the following priority areas:

Security vulnerabilities: Identify critical issues in authentication, payment processing, and API endpoints
Code quality: Highlight patterns of repetition, unnecessary complexity, and opportunities for refactoring
Performance optimization: Suggest specific improvements for frontend loading times and backend efficiency
UI/UX enhancements: Recommend concrete improvements for user flows, particularly in booking and authentication
Architecture recommendations: Propose any structural changes that would improve maintainability
For each issue identified, please include:

Severity rating (Critical, High, Medium, Low)
Specific file locations affected
Concrete code examples showing the improvement
Brief explanation of why the change is beneficial
Please prioritize tasks that are marked as 'done' since these represent the most mature code. For pending tasks, focus on architectural recommendations rather than implementation details."

---

_**Assistant**_

Below is a focused, task‑aligned review using your Taskmaster list. I prioritize tasks marked done, then add architectural guidance for pending items. Each item includes severity, exact locations, a concrete improvement example, and rationale.

Top fixes to prioritize first
- Critical: Harden Stripe webhook verification and idempotency
- Critical: Server-authoritative pricing/amounts for payments and subscriptions
- High: Rate limit login/register/NextAuth and admin APIs
- High: Centralize role checks for admin routes and remove debug routes in production
- High: Security headers + CSP
- High: Cache schedule/video queries and split heavy client bundles

Task 8 — Class Booking & Stripe Payment Flow (done)
1) Stripe webhook verification and idempotency
- Severity: Critical
- Files: `route.ts`, `schema.prisma`
- Issue: App Router requires verifying signatures against the raw request body; ensure you store and de-duplicate event IDs.
- Improvement:
````ts
import { NextRequest, NextResponse } from 'next/server'
import Stripe from 'stripe'
import { prisma } from '@/lib/prisma'
import { stripe } from '@/lib/stripe'

export async function POST(req: NextRequest) {
  const sig = req.headers.get('stripe-signature')
  if (!sig) return NextResponse.json({ error: 'Missing signature' }, { status: 400 })

  const rawBody = await req.text() // critical: use raw body, not JSON
  let event: Stripe.Event

  try {
    event = stripe.webhooks.constructEvent(rawBody, sig, process.env.STRIPE_WEBHOOK_SECRET!)
  } catch (err) {
    return NextResponse.json({ error: `Invalid signature` }, { status: 400 })
  }

  // Idempotency: skip if already processed
  const exists = await prisma.webhookEvent.findUnique({ where: { eventId: event.id } })
  if (exists) return NextResponse.json({ ok: true, deduped: true })

  await prisma.$transaction(async (tx) => {
    await tx.webhookEvent.create({
      data: { eventId: event.id, type: event.type, raw: event as unknown as object }
    })

    // ...existing code... handle `checkout.session.completed`, `customer.subscription.updated`, etc.
  })

  return NextResponse.json({ ok: true })
}
````
- Benefit: Prevents forged webhook calls and duplicate side effects.

2) Server-authoritative pricing and Stripe idempotency on PaymentIntent
- Severity: Critical
- Files: `route.ts`, `index.ts`
- Issue: Amount must be derived from the class price in DB, not from client; also include Stripe Idempotency-Key for retries.
- Improvement:
````ts
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { stripe } from '@/lib/stripe'

export async function POST(req: NextRequest) {
  const { classId } = await req.json()
  const sessionIdempotencyKey = req.headers.get('x-idempotency-key') ?? crypto.randomUUID()

  const klass = await prisma.class.findUnique({ where: { id: classId }, select: { priceCents: true, title: true } })
  if (!klass) return NextResponse.json({ error: 'class_not_found' }, { status: 404 })

  const amount = klass.priceCents // server-calculated
  const pi = await stripe.paymentIntents.create(
    {
      amount,
      currency: 'gbp',
      metadata: { classId },
      automatic_payment_methods: { enabled: true },
    },
    { idempotencyKey: sessionIdempotencyKey }
  )

  return NextResponse.json({ clientSecret: pi.client_secret })
}
````
- Benefit: Defends against client tampering and duplicates on network retries.

3) Booking confirmation race safety (capacity, unique constraints)
- Severity: High
- Files: `route.ts`, `schema.prisma`
- Issue: Ensure unique userId_classId and count capacity inside a single transaction.
- Improvement:
````ts
import { prisma } from '@/lib/prisma'
import { NextRequest, NextResponse } from 'next/server'

export async function POST(req: NextRequest) {
  const { classId, paymentIntentId } = await req.json()

  const result = await prisma.$transaction(async (tx) => {
    const klass = await tx.class.findUnique({ where: { id: classId }, select: { capacity: true } })
    if (!klass) return { error: 'class_not_found', status: 404 }

    const confirmedCount = await tx.booking.count({ where: { classId, status: 'CONFIRMED' } })
    if (confirmedCount >= (klass.capacity ?? 0)) return { error: 'capacity_full', status: 409 }

    // ...existing code... verify PaymentIntent succeeded + metadata integrity

    const booking = await tx.booking.create({
      data: { classId, status: 'CONFIRMED' },
    })
    return { booking }
  })

  if ('error' in result) return NextResponse.json({ error: result.error }, { status: result.status })
  return NextResponse.json({ booking: result.booking })
}
````
- Benefit: Eliminates overbooking race conditions.

Task 9 — Membership Subscriptions (done)
4) Validate plan keys and restrict return URLs
- Severity: High
- Files: `route.ts`, `plans.ts`
- Issue: Validate planKey against registry and restrict success/cancel URLs to site origin.
- Improvement:
````ts
import { NextRequest, NextResponse } from 'next/server'
import { stripe } from '@/lib/stripe'
import { PLAN_DEFINITIONS } from '@/lib/stripe/plans'

export async function POST(req: NextRequest) {
  const { planKey } = await req.json()
  const def = PLAN_DEFINITIONS[planKey as keyof typeof PLAN_DEFINITIONS]
  if (!def?.priceId) return NextResponse.json({ error: 'plan_not_found' }, { status: 400 })

  const origin = new URL(req.url).origin
  const session = await stripe.checkout.sessions.create({
    mode: 'subscription',
    line_items: [{ price: def.priceId, quantity: 1 }],
    success_url: `${origin}/membership/success?session_id={CHECKOUT_SESSION_ID}`,
    cancel_url: `${origin}/membership`,
  })

  return NextResponse.json({ url: session.url })
}
````
- Benefit: Prevents open redirect and invalid plan requests.

5) Membership in session
- Severity: Medium
- Files: `nextauth.ts`
- Issue: Expose active membership fields in JWT/session for gating UI and API.
- Improvement:
````ts
// ...existing code...
callbacks: {
  async session({ session, token }) {
    session.user.membership = {
      active: !!token.membershipActive,
      planKey: token.planKey ?? null,
    }
    return session
  },
  async jwt({ token, user }) {
    // ...existing code... load membership once and cache in token
    // token.membershipActive = true/false; token.planKey = 'premium'
    return token
  },
},
````
- Benefit: Consistent, cached membership checks across app.

Task 4 & 5 — Authentication & Logout (done)
6) Rate limiting on auth endpoints
- Severity: High
- Files: `route.ts`, `route.ts`, [src/app/api/auth/[...nextauth]/route.ts](src/app/api/auth/%5B...nextauth%5D/route.ts)
- Issue: No explicit rate limiting on sensitive endpoints.
- Improvement:
````ts
import { Ratelimit } from '@upstash/ratelimit'
import { Redis } from '@upstash/redis'
import { NextRequest, NextResponse } from 'next/server'

const limiter = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.fixedWindow(5, '60 s'),
})

export async function POST(req: NextRequest) {
  const ip = req.headers.get('x-forwarded-for') ?? 'unknown'
  const { success } = await limiter.limit(`login:${ip}`)
  if (!success) return NextResponse.json({ error: 'rate_limited' }, { status: 429 })

  // ...existing code...
}
````
- Benefit: Mitigates brute force and abuse.

7) Secure NextAuth cookies and production flags
- Severity: Medium
- Files: `nextauth.ts`
- Issue: Ensure cookies are secure and debug off in prod; confirm NEXTAUTH_SECRET present.
- Improvement:
````ts
// ...existing code...
cookies: {
  sessionToken: {
    name: 'next-auth.session-token',
    options: { httpOnly: true, sameSite: 'lax', secure: true, path: '/' },
  },
},
debug: process.env.NODE_ENV !== 'production' ? true : false,
````
- Benefit: Hardens session handling for production.

Task 12 — Admin Dashboard (done)
8) Centralize admin authorization checks
- Severity: High
- Files: src/app/api/admin/**, `middleware.ts`
- Issue: Ensure all admin APIs enforce admin role, consistently.
- Improvement:
````ts
import { getServerSession } from 'next-auth'
import { authOptions } from './nextauth'

export async function requireAdmin() {
  const session = await getServerSession(authOptions)
  if (!session?.user?.role || session.user.role !== 'ADMIN') {
    throw new Response('forbidden', { status: 403 })
  }
}
````
- Use in routes:
````ts
// ...existing code...
import { requireAdmin } from '@/lib/auth/middleware'

export async function GET() {
  await requireAdmin()
  // ...existing code...
}
````
- Benefit: Prevents privilege bypass and normalizes enforcement.

9) Validate admin payloads with Zod
- Severity: Medium
- Files: src/app/api/admin/classes/**, `booking.ts`
- Issue: Missing/duplicated input validation.
- Improvement:
````ts
import { z } from 'zod'
export const createClassSchema = z.object({
  title: z.string().min(1),
  startsAt: z.string(),
  capacity: z.number().int().min(0),
})
````
- Benefit: Consistent, typed request validation and better errors.

Task 7 — Class Schedule (done)
10) Cache schedule queries and reduce payloads
- Severity: Medium
- Files: `page.tsx`, `ScheduleClient.tsx`, src/app/classes/route.ts
- Issue: Potential repeated server calls and large JSON.
- Improvement:
````ts
// Use a Server Component + cache select fields only
import { prisma } from '@/lib/prisma'
import { unstable_cache } from 'next/cache'

const getClasses = unstable_cache(async () => {
  return prisma.class.findMany({
    select: { id: true, title: true, startsAt: true, capacity: true, confirmedCount: true },
    orderBy: { startsAt: 'asc' },
  })
}, ['schedule:list'], { revalidate: 60 })

export default async function Page() {
  const classes = await getClasses()
  // ...existing code...
}
````
- Benefit: Faster TTFB and smaller payloads.

Task 3 — UI Library (done)
11) A11y improvements for form errors and focus
- Severity: Medium
- Files: `input.tsx`, `SignInForm.tsx`
- Issue: Ensure errors are announced and focus is visible.
- Improvement:
````tsx
// ...existing code...
<p role="alert" aria-live="polite" className="text-sm text-red-600">
  {errorMessage}
</p>
````
- Benefit: Better screen reader support and WCAG conformance.

Task 2 — Schema & Migrations (done)
12) Add/prune indexes for common filters
- Severity: Medium
- Files: `schema.prisma`
- Issue: Ensure frequent lookups have indexes (startsAt, userId/classId, eventId).
- Improvement:
````prisma
model Booking {
  id        String @id @default(cuid())
  userId    String
  classId   String
  status    String
  @@unique([userId, classId])
}

model WebhookEvent {
  id      String @id @default(cuid())
  eventId String @unique
  type    String
  raw     Json
}
````
- Benefit: Faster queries and enforced idempotency at DB.

Cross-cutting security (applies to done tasks)
13) Security headers and CSP
- Severity: High
- Files: `next.config.ts`
- Issue: Missing standard security headers.
- Improvement:
````ts
const nextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          { key: 'X-Frame-Options', value: 'DENY' },
          { key: 'X-Content-Type-Options', value: 'nosniff' },
          { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
          { key: 'Permissions-Policy', value: 'camera=(), microphone=(), geolocation=()' },
          // Consider strict CSP tuned to your needs
          { key: 'Content-Security-Policy', value: "default-src 'self'; img-src 'self' data: https:;" },
        ],
      },
    ]
  },
}
export default nextConfig
````
- Benefit: Browser-enforced defenses against common attacks.

14) Remove or protect debug/test routes in production
- Severity: Medium
- Files: `route.ts`, src/app/api/test-*/route.ts
- Issue: Information disclosure in prod.
- Improvement:
````ts
if (process.env.NODE_ENV === 'production') {
  export async function GET() {
    return new Response('not_found', { status: 404 })
  }
}
````
- Benefit: Prevents leakage of auth/session state and test utilities.

Frontend performance (done tasks impact)
15) Split heavy client bundles and lazy-load
- Severity: Medium
- Files: `VideoLibraryClient.tsx`, `VideoPlayer.tsx`, `BookingForm.tsx`
- Issue: Client hydration cost for large components.
- Improvement:
````tsx
import dynamic from 'next/dynamic'
const VideoPlayer = dynamic(() => import('@/components/video/VideoPlayer'), { ssr: false })

export default function VideoLibraryClient() {
  // ...existing code...
}
````
- Benefit: Smaller initial JS, better LCP/TTI.

UI/UX enhancements (done tasks)
16) Auth form polish (autofocus, password toggle aria)
- Severity: Low
- Files: `SignInForm.tsx`
- Improvement:
````tsx
<input id="email" name="email" type="email" autoFocus aria-describedby="email-help" />
````
- Benefit: Faster task completion and accessibility.

Pending tasks — architectural recommendations
Task 10/11 Video + Progress (pending)
- Use signed URLs and short-lived tokens via `mux.ts`; gate access with membership in server components.
- Store progress writes behind a debounced API with rate limiting; return minimal JSON.

Task 18 Security (pending)
- Extend rate limiting to all auth/payment endpoints (already outlined).
- Add Semgrep CI checks for common SSRF/NoSQL/Injection patterns.

Task 19/20 Accessibility & Performance (pending)
- Add automated Axe tests over main pages; enforce WCAG via CI.
- Adopt Next/Image everywhere on public pages; convert SVG/PNG where applicable.
- Introduce React Server Components where possible (schedule, membership page lists).

Notable repetition and refactor opportunities
- Centralize error codes and mapping: `index.ts` can be the single source, used by both server (API) and client (UI).
- Move business logic out of route handlers into services: e.g., booking/subscription operations into `index.ts`, `index.ts`; keep routes thin.
- Reuse Zod schemas in both client and server: keep shared schemas in ``.

Final notes
- Your Task 8/9 implementations show solid attention to idempotency and error surfacing. The critical hardening items above (webhook raw verification, server-authoritative amounts, global rate limiting, admin gating, headers/CSP) will meaningfully raise security posture.
- After applying the top items, run Stripe’s webhook replay tests and a basic DAST scan to validate protections.

---

